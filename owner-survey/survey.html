<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사장님 MBTI 설문</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="container">
    <h1>사장님 MBTI 설문</h1>
    <p>간단한 질문을 통해 당신의 운영 스타일을 진단합니다.</p>

    <form id="survey-form"></form>

    <div class="button-wrapper">
      <button id="next-button">다음 단계로</button>
    </div>
  </div>
  <script>
    // ✅ 항상 새 설문으로 시작하도록 기존 데이터 초기화
    localStorage.removeItem("surveyAnswers");
    localStorage.removeItem("surveyScores");
    localStorage.removeItem("resultSaved");
    localStorage.removeItem("savedAt");

    // ✅ 새 UUID 생성 및 저장
    const uuid = crypto.randomUUID();
    localStorage.setItem("uuid", uuid);

    let stage = 0;
    const answers = {};
    const scores = { S: 0, I: 0, W: 0, T: 0, L: 0, R: 0, E: 0, Q: 0 };
    let questionsData;
    let currentStageQuestions = [];
    let stage2Target = "";
    let stage3Target = "";

    // loadQuestions 함수에서 renderQuestions(questionsData.common); 호출 제거
    async function loadQuestions() {
      const response = await fetch("data/question.json");
      questionsData = await response.json();
      // renderQuestions(questionsData.common); // <-- 이 줄은 제거합니다.
    }
    function renderQuestions(questions) {
      const form = document.getElementById("survey-form");
      form.innerHTML = "";

      questions.forEach((q, index) => {
        const fieldset = document.createElement("fieldset");
        const legend = document.createElement("legend");
        legend.textContent = `${index + 1}. ${q.question}`;
        fieldset.appendChild(legend);

        q.options.forEach((opt, optIndex) => {
          const label = document.createElement("label");
          label.className = "option-label";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = `question-${index}`;
          input.value = optIndex;
          input.required = true;

          label.appendChild(input);
          label.appendChild(document.createTextNode(opt));
          fieldset.appendChild(label);
        });

        form.appendChild(fieldset);
      });
      currentStageQuestions = questions;
    }

    function saveAnswersAndScore() {
      const formData = new FormData(document.getElementById("survey-form"));
      [...formData.entries()].forEach(([key, value], idx) => {
        answers[key] = value;

        const q = currentStageQuestions[idx];
        if (q.type) {
          const [left, right] = q.type.split("/");
          if (value == "0") scores[left]++;
          else scores[right]++;
        }
      });
    }

    function getClosestPair() {
      let minDiff = Infinity;
      let selected = "";
      const pairs = ["SI", "WT", "LR", "EQ"];

      for (const pair of pairs) {
        const a = pair[0], b = pair[1];
        const diff = Math.abs(scores[a] - scores[b]);
        if (diff < minDiff) {
          minDiff = diff;
          selected = pair;
        }
      }
      return selected;
    }

    document.getElementById("next-button").addEventListener("click", (e) => {
      e.preventDefault();
      // 첫 단계에서는 답변 저장을 하지 않습니다 (소개 화면이므로)
      if (stage > 0) { // stage가 0보다 클 때만 답변을 저장하고 점수를 매깁니다.
        saveAnswersAndScore();
      }
      stage++;

      switch (stage) {
        case 1: // 이제 stage가 1이 되었을 때 common 질문을 로드합니다.
          renderQuestions(questionsData.common);
          break;
        case 2:
          renderQuestions(questionsData.stage1);
          break;
        case 3:
          stage2Target = getClosestPair();
          renderQuestions(questionsData.stage2[stage2Target]);
          break;
        case 4:
          stage3Target = getClosestPair();
          renderQuestions(questionsData.stage3[stage3Target]);
          break;
        case 5: // 최종 결과 페이지로 이동하는 단계는 stage 5가 됩니다.
          localStorage.setItem("surveyAnswers", JSON.stringify(answers));
          localStorage.setItem("surveyScores", JSON.stringify(scores));
          localStorage.setItem("savedAt", Date.now());
          window.location.href = "result.html";
          break;
      }
    });

    loadQuestions(); // questionsData를 미리 불러오기 위해 이 호출은 유지합니다.
  </script>
</body>

</html>