<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>설문 결과</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }

    .result-wrapper {
      max-width: 600px;
      margin: 3em auto;
      padding: 2em;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      text-align: center;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5em;
    }

    p {
      font-size: 1rem;
      color: #4b5563;
    }

    .kakao-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-top: 2em;
      padding: 0.8em 2em;
      font-size: 1.1em;
      background-color: #fee500;
      color: #3c1e1e;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }

    .kakao-btn:hover {
      background-color: #f7e100;
    }

    .back-btn {
      display: inline-block;
      margin-top: 1em;
      padding: 0.8em 2em;
      font-size: 1.1em;
      background-color: #e5e7eb;
      color: #4b5563;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }

    .back-btn:hover {
      background-color: #d1d5db;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
  </style>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
</head>

<body>
  <div class="result-wrapper">
    <h2>사장님의 MOTI 설문이 완료되었습니다!</h2>
    <p>사장님의 유형 및 맞춤 결과는 카카오톡 채널을 통해 전송됩니다.</p>

    <button class="kakao-btn" onclick="submitResult()">
      <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png" alt="카카오 아이콘"
        class="h-5 mr-2" />
      카카오로 결과 받기
    </button>
    <a href="survey.html" class="back-btn">다시 하기</a>
  </div>

  <div id="modal-overlay" class="modal-overlay">
    <div class="modal">
      <p id="modal-message" class="text-gray-800"></p>
      <button id="modal-close-btn"
        class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">확인</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let app, db, auth;
    let userId = "";
    let isFirebaseReady = false;

    // Canvas 환경의 전역 변수가 있으면 사용하고, 없으면 하드코딩된 값을 사용
    const appId = 'nbso-b7f41'; // (당신 규칙에 맞춘 실제 값)

    function showModal(message) {
      document.getElementById("modal-message").innerText = message;
      document.getElementById("modal-overlay").classList.add("show");
    }

    document.getElementById("modal-close-btn").addEventListener("click", () => {
      document.getElementById("modal-overlay").classList.remove("show");
    });

    /**
     * Firebase를 초기화하고 익명 로그인을 수행합니다.
     * 인증 상태가 변경될 때마다 userId를 업데이트하고 설문 결과를 저장하는 로직을 실행합니다.
     */
    async function setupFirebase() {
      try {
        const providedConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
          apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
          authDomain: "nbso-b7f41.firebaseapp.com",
          projectId: "nbso-b7f41",
          storageBucket: "nbso-b7f41.firebasestorage.app",
          messagingSenderId: "94203359555",
          appId: "1:94203359555:web:07f9ee21d1291670363ff6",
          measurementId: "G-YCWF8ENKC4"
        };

        if (Object.keys(providedConfig).length > 0) {
          app = initializeApp(providedConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // 익명 로그인 시도 (이미 로그인되어 있으면 그대로 유지)
          const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          // 인증 상태 변화를 감지하는 리스너 설정
          onAuthStateChanged(auth, user => {
            if (user) {
              userId = user.uid;
              isFirebaseReady = true;
              console.log("✅ Firebase 초기화 및 로그인 완료. User ID:", userId);

              // 페이지 로드 시 결과 자동 저장 (단, 이미 저장되지 않았을 경우)
              if (localStorage.getItem("resultSaved") !== "true") {
                saveResultToFirestore();
              }
            } else {
              console.error("❌ Firebase 인증 상태 변경 실패: 사용자가 없습니다.");
            }
          });

        } else {
          console.error("❌ Firebase 설정이 유효하지 않습니다.");
        }
      } catch (error) {
        console.error("❌ Firebase 초기화 또는 로그인 중 오류:", error);
      }
    }

    /**
     * 설문 결과를 Firestore에 저장합니다. 익명 로그인 후 딱 한 번만 실행됩니다.
     */
    async function saveResultToFirestore() {
      if (!isFirebaseReady || !userId) {
        console.error("❌ Firebase가 아직 준비되지 않았습니다. 잠시 후 다시 시도해 주세요.");
        return null;
      }

      // localStorage에 이미 결과가 저장되어 있다면 중복 저장하지 않음
      if (localStorage.getItem("resultSaved") === "true") {
        console.log("ℹ️ 설문 결과가 이미 저장되었습니다. UUID:", localStorage.getItem("surveyUUID"));
        return localStorage.getItem("surveyUUID");
      }

      const answers = JSON.parse(localStorage.getItem("surveyAnswers"));
      const scores = JSON.parse(localStorage.getItem("surveyScores"));
      const surveyUUID = crypto.randomUUID(); // 고유 ID 생성

      try {
        const res = await fetch("data/question.json");
        const questionsData = await res.json();

        const allResponses = [];
        const questionMap = {};
        questionsData.common.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "common" });
        questionsData.stage1.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage1" });
        for (const key in questionsData.stage2) {
          questionsData.stage2[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage2" });
        }
        for (const key in questionsData.stage3) {
          questionsData.stage3[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage3" });
        }

        for (const key in answers) {
          if (key.startsWith('question-')) {
            const globalIndex = key.split('-')[1];
            const q = questionMap[globalIndex];
            const answerValue = answers[key];

            if (q && answerValue !== undefined) {
              const entry = {
                stage: q.stage,
                question: q.question,
                answer: q.options[answerValue]
              };
              if (q.type) {
                const [left, right] = q.type.split("/");
                entry.type = q.type;
                entry.score = answerValue == "0" ? left : right;
              }
              allResponses.push(entry);
            }
          }
        }

        const finalType = calculateFinalType(scores);
        const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1시간 후 만료

        const docRef = doc(db, `artifacts/${appId}/public/data/survey_results`, surveyUUID);
        await setDoc(docRef, {
          ownerUid: userId, // 익명 사용자의 UID를 ownerUid로 저장
          timestamp: serverTimestamp(),
          createdAt: serverTimestamp(),
          expiresAt: new Date(Date.now() + 60 * 60 * 1000),
          kakaoLinked: false,
          linkedAt: null,
          responses: allResponses,
          finalScores: scores,
          finalType: finalType,
        });

        localStorage.setItem("resultSaved", "true");
        localStorage.setItem("surveyUUID", surveyUUID);
        console.log("✅ 설문 결과 저장됨. UUID:", surveyUUID, "Owner UID:", userId);
        return surveyUUID;
      } catch (error) {
        console.error("❌ Firestore 저장 중 오류:", error);
        showModal("설문 결과 저장 중 오류가 발생했습니다.");
        return null;
      }
    }

    function calculateFinalType(scores) {
      let motiType = "";
      const pairs = [
        { axis1: "S", axis2: "I" },
        { axis1: "W", axis2: "T" },
        { axis1: "L", axis2: "R" },
        { axis1: "E", axis2: "Q" }
      ];

      pairs.forEach(pair => {
        if (scores[pair.axis1] > scores[pair.axis2]) {
          motiType += pair.axis1;
        } else if (scores[pair.axis2] > scores[pair.axis1]) {
          motiType += pair.axis2;
        } else {
          motiType += pair.axis1;
        }
      });
      return motiType;
    }

    /**
     * '카카오로 결과 받기' 버튼 클릭 시 실행되는 함수.
     * 익명으로 저장된 문서에 카카오 정보를 업데이트합니다.
     */
    window.submitResult = async function () {
      if (!isFirebaseReady) {
        showModal("서버 연결 중입니다. 잠시 후 다시 시도해 주세요.");
        return;
      }

      const surveyUUID = localStorage.getItem("surveyUUID");
      if (!surveyUUID) {
        showModal("설문 결과 문서가 생성되지 않았습니다. 다시 시도해 주세요.");
        return;
      }

      // 카카오 로그인 로직 (기존 코드 유지)
      Kakao.Auth.login({
        success: function (authObj) {
          Kakao.API.request({
            url: '/v2/user/me',
            success: async function (res) {
              const kakaoId = res.id.toString();
              const account = res.kakao_account;

              // 익명으로 저장된 설문 결과 문서에 카카오 정보 업데이트
              const surveyDocRef = doc(db, `artifacts/${appId}/public/data/survey_results`, surveyUUID);
              try {
                await updateDoc(surveyDocRef, {
                  kakaoLinked: true,
                  linkedAt: serverTimestamp(),
                  kakaoUid: kakaoId,
                  kakaoEmail: account?.email ?? null,
                  kakaoNickname: account?.profile?.nickname ?? null,
                });

                console.log("✅ 설문 결과 문서에 카카오 정보 업데이트 완료.");

                // 카카오 사용자 정보 별도 저장
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, kakaoId);
                const userData = {
                  name: account?.name ?? null,
                  gender: account?.gender ?? null,
                  age_range: account?.age_range ?? null,
                  birthday: account?.birthday ?? null,
                  phone_number: account?.phone_number ?? null,
                  timestamp: serverTimestamp(),
                  surveyResults: [surveyUUID],
                };

                await setDoc(userRef, userData, { merge: true });

                console.log("✅ Firestore 사용자 정보 업데이트 완료.");
                window.location.href = `kakao-login-success.html?uuid=${surveyUUID}`;
              } catch (error) {
                console.error("❌ Firestore 업데이트 실패:", error);
                showModal("회원가입/로그인 정보 저장 실패");
              }
            },
            fail: function (error) {
              console.error("❌ 사용자 정보 요청 실패:", error);
              showModal("사용자 정보 요청 실패");
            }
          });
        },
        fail: function (err) {
          console.error("❌ 로그인 실패:", err);
          showModal("카카오 로그인 실패");
        }
      });
    };

    window.onload = async function () {
      await setupFirebase();
      Kakao.init("cc58d703cacde86ff1976fd723a04854");
      console.log("✅ 카카오 SDK 초기화 완료");
    };
  </script>
</body>

</html>