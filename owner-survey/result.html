<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>설문 결과</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="result-wrapper bg-white p-8 sm:p-12 rounded-xl shadow-lg w-full max-w-2xl">
    <div id="result-content" class="flex flex-col items-center">
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-4 text-center">
        사장님의 MOTI 설문이 완료되었습니다!
      </h2>
      <p class="text-gray-600 mb-8 text-center">
        자세한 유형 분석 및 맞춤 결과는 카카오톡 채널을 통해 전송됩니다.
      </p>

      <!-- 버튼 섹션 -->
      <div class="mt-8 flex flex-col sm:flex-row sm:space-x-4 w-full">
        <button id="kakao-btn" onclick="submitResult()"
          class="kakao-btn w-full flex items-center justify-center bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 mb-4 sm:mb-0">
          <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png" alt="카카오 아이콘"
            class="h-5 mr-2" />
          카카오로 결과 받기
        </button>
        <a href="survey.html"
          class="back-btn w-full flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
          다시 하기
        </a>
      </div>
    </div>
  </div>

  <!-- 모달 UI -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full text-center">
      <p id="modal-message" class="text-gray-800 text-lg mb-4"></p>
      <button id="modal-close-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
        확인
      </button>
    </div>
  </div>

  <!-- 카카오 SDK -->
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 전역 변수 설정
    // ❌ 환경 변수가 제공되지 않을 때를 대비해 Firebase 설정을 수동으로 추가합니다.
    const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
      ? JSON.parse(__firebase_config)
      : {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    let app, db, auth;
    let userId = null;
    let isFirebaseReady = false;

    // 모달 관련 함수
    function showModal(message) {
      document.getElementById("modal-message").innerText = message;
      document.getElementById("modal-overlay").classList.remove("hidden");
    }

    document.getElementById("modal-close-btn").addEventListener("click", () => {
      document.getElementById("modal-overlay").classList.add("hidden");
    });

    // Firebase 초기화 및 인증
    async function setupFirebase() {
      try {
        if (Object.keys(firebaseConfig).length > 0) {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          userId = auth.currentUser?.uid || crypto.randomUUID();
          console.log("✅ Firebase 초기화 및 로그인 완료. User ID:", userId);
          isFirebaseReady = true;
          return userId;
        } else {
          console.error("❌ Firebase 설정이 유효하지 않습니다.");
          showModal("Firebase 설정이 올바르지 않습니다.");
          return null;
        }
      } catch (error) {
        console.error("❌ Firebase 초기화 또는 로그인 중 오류:", error);
        showModal("Firebase 연결 중 오류가 발생했습니다. 다시 시도해 주세요.");
        return null;
      }
    }

    // 설문 결과 Firestore 저장 함수
    async function saveResultToFirestore(currentUserId) {
      if (!isFirebaseReady) {
        showModal("서버 연결에 문제가 있습니다. 잠시 후 다시 시도해 주세요.");
        return null;
      }

      // 이미 저장된 경우 UUID 반환
      const storedUUID = localStorage.getItem("surveyUUID");
      if (localStorage.getItem("resultSaved") === "true" && storedUUID) {
        console.log("ℹ️ 설문 결과가 이미 저장되었습니다. UUID:", storedUUID);
        return storedUUID;
      }

      const answers = JSON.parse(localStorage.getItem("surveyAnswers"));
      const scores = JSON.parse(localStorage.getItem("surveyScores"));

      // 답변 데이터가 없는 경우
      if (!answers || !scores) {
        showModal("설문 결과 데이터가 없습니다. 다시 설문에 참여해 주세요.");
        return null;
      }

      try {
        // 설문 질문 데이터를 다시 불러와 답변 내용을 상세하게 저장하는 로직
        const res = await fetch("data/question.json");
        const questionsData = await res.json();

        const allResponses = [];
        const questionMap = {};
        questionsData.common.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "common" });
        questionsData.stage1.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage1" });
        for (const key in questionsData.stage2) {
          questionsData.stage2[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage2" });
        }
        for (const key in questionsData.stage3) {
          questionsData.stage3[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage3" });
        }

        for (const key in answers) {
          if (key.startsWith('question-')) {
            const globalIndex = key.split('-')[1];
            const q = questionMap[globalIndex];
            const answerValue = answers[key];

            if (q && answerValue !== undefined) {
              const entry = {
                stage: q.stage,
                question: q.question,
                answer: q.options[answerValue]
              };
              if (q.type) {
                const [left, right] = q.type.split("/");
                entry.type = q.type;
                entry.score = answerValue == "0" ? left : right;
              }
              allResponses.push(entry);
            }
          }
        }

        // 최종 유형 계산
        function calculateFinalType(scores) {
          let motiType = "";
          const pairs = [
            { axis1: "S", axis2: "I" },
            { axis1: "W", axis2: "T" },
            { axis1: "L", axis2: "R" },
            { axis1: "E", axis2: "Q" }
          ];
          pairs.forEach(pair => {
            if (scores[pair.axis1] > scores[pair.axis2]) {
              motiType += pair.axis1;
            } else if (scores[pair.axis2] > scores[pair.axis1]) {
              motiType += pair.axis2;
            } else {
              motiType += pair.axis1;
            }
          });
          return motiType;
        }

        const finalType = calculateFinalType(scores);

        // 설문 결과 저장 경로: /artifacts/{appId}/public/data/survey_results
        const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/survey_results`), {
          timestamp: serverTimestamp(),
          responses: allResponses, // 상세 답변 내용 저장
          finalScores: scores,
          finalType: finalType, // 최종 유형 저장
          userId: currentUserId, // Firebase 인증 UID 저장
          loginSource: "result",
          connectedAt: null,
        });

        localStorage.setItem("resultSaved", "true");
        localStorage.setItem("surveyUUID", docRef.id);
        console.log("✅ 설문 결과 저장됨. UUID:", docRef.id);
        return docRef.id;
      } catch (error) {
        console.error("❌ Firestore 저장 중 오류:", error);
        showModal("설문 결과 저장 중 오류가 발생했습니다.");
        return null;
      }
    }

    // 카카오 로그인 및 결과 연결 함수
    async function connectKakaoAndSaveResult() {
      const surveyUUID = await saveResultToFirestore(userId);
      if (!surveyUUID) return;

      // 💡 로그인 성공 시 리다이렉트 URL에 UUID를 추가하여 kakao-login-success.html에서 사용할 수 있도록 합니다.
      Kakao.Auth.login({
        success: function (authObj) {
          console.log("✅ 카카오 로그인 성공:", JSON.stringify(authObj));
          window.location.href = `kakao-login-success.html?uuid=${surveyUUID}`;
        },
        fail: function (err) {
          console.error("❌ 카카오 로그인 실패:", JSON.stringify(err));
          showModal("카카오 로그인에 실패했습니다.");
        }
      });
    }

    window.submitResult = connectKakaoAndSaveResult;

    // 페이지 로드 시 실행
    window.onload = async function () {
      // Firebase 초기화 및 인증 후 userId를 받습니다.
      const authenticatedUserId = await setupFirebase();
      if (authenticatedUserId) {
        // userId를 사용하여 설문 결과를 Firestore에 저장합니다.
        await saveResultToFirestore(authenticatedUserId);
      }

      // 카카오 SDK 초기화
      if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        // 💡 YOUR_KAKAO_API_KEY 대신 실제 API 키를 입력하세요.
        Kakao.init("cc58d703cacde86ff1976fd723a04854");
        console.log("✅ 카카오 SDK 초기화 완료");
      }

      // 카카오 로그인 버튼에 이벤트 리스너 추가
      document.getElementById('kakao-btn').addEventListener('click', connectKakaoAndSaveResult);
    };
  </script>
</body>

</html>