<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>설문 결과</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }

    .result-wrapper {
      max-width: 600px;
      margin: 3em auto;
      padding: 2em;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      text-align: center;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5em;
    }

    p {
      font-size: 1rem;
      color: #4b5563;
    }

    .kakao-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-top: 2em;
      padding: 0.8em 2em;
      font-size: 1.1em;
      background-color: #fee500;
      color: #3c1e1e;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }

    .kakao-btn:hover {
      background-color: #f7e100;
    }

    .back-btn {
      display: inline-block;
      margin-top: 1em;
      padding: 0.8em 2em;
      font-size: 1.1em;
      background-color: #e5e7eb;
      color: #4b5563;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }

    .back-btn:hover {
      background-color: #d1d5db;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
  </style>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
</head>

<body>
  <div class="result-wrapper">
    <h2>사장님의 MOTI 설문이 완료되었습니다!</h2>
    <p>사장님의 유형 및 맞춤 결과는 로그인 후 마이페이지에서 확인 하실 수 있습니다.</p>

    <button class="kakao-btn" onclick="submitResult()">
      <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png" alt="카카오 아이콘"
        class="h-5 mr-2" />
      3초 로그인 후 결과보기
    </button>
    <a href="survey.html" class="back-btn">다시 하기</a>
  </div>

  <div id="modal-overlay" class="modal-overlay">
    <div class="modal">
      <p id="modal-message" class="text-gray-800"></p>
      <button id="modal-close-btn"
        class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">확인</button>
    </div>
  </div>
  <!-- Firebase v9 modules -->
  <script type="module">
    /********************
     *  Firebase 설정  *
     ********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    let app, db, auth;
    let userId = null; // Firebase UID
    let isFirebaseReady = false;

    // 외부에서 주입된 구성(선택) 사용: window.__firebase_config, window.__initial_auth_token
    const providedConfig = (typeof window.__firebase_config !== 'undefined' && window.__firebase_config)
      ? (typeof window.__firebase_config === 'string' ? JSON.parse(window.__firebase_config) : window.__firebase_config)
      : {
        apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
        authDomain: "nbso-b7f41.firebaseapp.com",
        projectId: "nbso-b7f41",
        storageBucket: "nbso-b7f41.appspot.com",
        messagingSenderId: "94203359555",
        appId: "1:94203359555:web:07f9ee21d1291670363ff6",
        measurementId: "G-YCWF8ENKC4"
      };

    async function setupFirebase() {
      try {
        app = initializeApp(providedConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const initialAuthToken = (typeof window.__initial_auth_token !== 'undefined') ? window.__initial_auth_token : null;
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            isFirebaseReady = true;
            console.log("✅ Firebase 로그인 완료:", userId);
            document.getElementById('status').textContent = '로그인 완료. 설문 결과 저장 중...';
            if (localStorage.getItem('resultSaved') !== 'true') {
              saveResultToFirestore();
            } else {
              document.getElementById('status').textContent = `이미 저장됨 · UUID: ${localStorage.getItem('surveyUUID') || '-'}`;
            }
          } else {
            document.getElementById('status').textContent = '로그인 실패';
            console.error('❌ Firebase 인증 사용자 없음');
          }
        });
      } catch (err) {
        console.error('❌ Firebase 초기화/로그인 오류:', err);
        document.getElementById('status').textContent = '초기화 오류';
      }
    }

    /**********************************************
     * 질문/답변 매핑 생성 (설문과 동일한 globalIndex 규칙)
     **********************************************/
    async function buildQuestionMap() {
      const res = await fetch('data/question.json');
      const questionsData = await res.json();

      // survey.html에서 했던 globalIndex 재부여 순서 그대로
      let currentGlobalIndex = 0;
      (questionsData.common || []).forEach(q => q.globalIndex = currentGlobalIndex++);
      (questionsData.stage1 || []).forEach(q => q.globalIndex = currentGlobalIndex++);
      for (const key in (questionsData.stage2 || {})) {
        (questionsData.stage2[key] || []).forEach(q => q.globalIndex = currentGlobalIndex++);
      }
      for (const key in (questionsData.stage3 || {})) {
        (questionsData.stage3[key] || []).forEach(q => q.globalIndex = currentGlobalIndex++);
      }

      const map = {};
      const add = (arr, stage) => (arr || []).forEach(q => {
        map[String(q.globalIndex)] = {
          question: q.question,
          options: q.options,
          type: q.type || null,
          stage
        };
      });
      add(questionsData.common, 'common');
      add(questionsData.stage1, 'stage1');
      for (const key in (questionsData.stage2 || {})) add(questionsData.stage2[key], 'stage2');
      for (const key in (questionsData.stage3 || {})) add(questionsData.stage3[key], 'stage3');
      return map;
    }

    function calculateFinalType(scores) {
      const pairs = [['S', 'I'], ['W', 'T'], ['L', 'R'], ['E', 'Q']];
      let t = '';
      for (const [a, b] of pairs) {
        if ((scores[a] || 0) > (scores[b] || 0)) t += a;
        else if ((scores[b] || 0) > (scores[a] || 0)) t += b;
        else t += a; // 동점이면 앞 축 선택(기존 로직 유지)
      }
      return t;
    }

    async function saveResultToFirestore() {
      if (!isFirebaseReady || !userId) {
        console.error('❌ Firebase 준비 안 됨');
        return null;
      }

      // 중복 저장 방지
      if (localStorage.getItem('resultSaved') === 'true') {
        return localStorage.getItem('surveyUUID');
      }

      const answers = JSON.parse(localStorage.getItem('surveyAnswers') || '{}');
      const scores = JSON.parse(localStorage.getItem('surveyScores') || '{}');
      const surveyUUID = crypto.randomUUID();

      try {
        const questionMap = await buildQuestionMap();

        const allResponses = [];
        for (const key in answers) {
          if (!key.startsWith('question-')) continue;
          const idx = key.split('-')[1];
          const q = questionMap[idx];
          const answerIndex = Number(answers[key]);
          if (!q || Number.isNaN(answerIndex)) continue;
          const entry = {
            stage: q.stage,
            question: q.question,
            answerIndex,
            answer: q.options?.[answerIndex]
          };
          if (q.type) {
            const [left, right] = q.type.split('/')
            entry.type = q.type;
            entry.score = (answerIndex === 0) ? left : right;
          }
          allResponses.push(entry);
        }

        const finalType = calculateFinalType(scores);
        const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1시간 TTL(연동 전)

        const docRef = doc(db, `users/${userId}/survey_results/${surveyUUID}`);
        await setDoc(docRef, {
          ownerUid: userId,
          createdAt: serverTimestamp(),
          timestamp: serverTimestamp(),
          expiresAt,
          kakaoLinked: false,
          linkedAt: null,
          finalScores: scores,
          finalType,
          responses: allResponses
        }, { merge: true });

        localStorage.setItem('resultSaved', 'true');
        localStorage.setItem('surveyUUID', surveyUUID);
        document.getElementById('status').textContent = `저장 완료 · UUID: ${surveyUUID}`;
        console.log('✅ 저장 완료', surveyUUID);
        return surveyUUID;
      } catch (err) {
        console.error('❌ 저장 오류:', err);
        document.getElementById('status').textContent = '저장 실패';
        return null;
      }
    }

    // 결과 링크 만들

    // 카카오톡(내 톡)으로 결과 보내기

    // 카카오로 결과 받기 (연동)
    // 카카오로 결과 받기 (연동 + 내 톡으로 결과 링크 전송)
    window.submitResult = async function () {
      if (!isFirebaseReady) {
        alert('서버 연결 중입니다. 잠시 후 다시 시도해주세요.');
        return;
      }

      const surveyUUID = localStorage.getItem('surveyUUID');
      if (!surveyUUID) {
        alert('설문 결과 문서가 생성되지 않았습니다. 다시 시도해주세요.');
        return;
      }

      if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        Kakao.init('cc58d703cacde86ff1976fd723a04854'); // JS 키
      }

      Kakao.Auth.login({
        // ✅ kakao-login.html 수준으로 수집 범위 확대
        scope: 'profile_nickname,profile_image,account_email,gender,age_range,birthday,phone_number',
        success: function () {
          Kakao.API.request({
            url: '/v2/user/me',
            success: async function (res) {
              try {
                const kakaoId = String(res?.id ?? '');
                const account = res?.kakao_account ?? {};
                const profile = account?.profile ?? {};

                const nickname = profile?.nickname ?? res?.properties?.nickname ?? null;
                const email = account?.email ?? null;
                const gender = account?.gender ?? null;       // 'male' | 'female' | null
                const ageRange = account?.age_range ?? null;    // 예: '20~29'
                const birthday = account?.birthday ?? null;     // 'MMDD'
                const phoneNumber = account?.phone_number ?? null; // E.164 (승인 필요)
                const profileImageUrl = profile?.profile_image_url
                  ?? res?.properties?.profile_image
                  ?? profile?.thumbnail_image_url
                  ?? null;

                // ✅ 저장 1) 중앙 프로필: users/{uid}
                await setDoc(
                  doc(db, `users/${userId}`),
                  {
                    uid: userId,
                    provider: 'kakao',
                    kakaoId,
                    displayName: nickname || '',
                    email,
                    gender,
                    ageRange,
                    birthday,
                    phoneNumber,
                    profileImageUrl,
                    lastLoginAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                  },
                  { merge: true }
                );

                // ✅ 저장 2) 민감/원본 스냅샷: users/{uid}/private/kakao
                await setDoc(
                  doc(db, `users/${userId}/private/kakao`),
                  {
                    kakaoId,
                    email,
                    nickname,
                    gender,
                    age_range: ageRange,
                    birthday,
                    phone_number: phoneNumber,
                    profile_image: profileImageUrl,
                    connectedAt: serverTimestamp(),
                    // 원본 전체(안전하게 직렬화해서 저장)
                    raw: JSON.parse(JSON.stringify(res))
                  },
                  { merge: true }
                );

                // (선택) 동의한 scope 목록 기록
                try {
                  Kakao.API.request({
                    url: '/v2/user/scopes',
                    success: async function (scopesRes) {
                      const consentedScopes = (scopesRes?.scopes ?? [])
                        .filter(s => s?.agreed)
                        .map(s => s?.id);
                      await setDoc(
                        doc(db, `users/${userId}`),
                        { consentedScopes, scopesUpdatedAt: serverTimestamp() },
                        { merge: true }
                      );
                    },
                    fail: function (e) {
                      console.warn('동의 scope 조회 실패(무시 가능):', e);
                    }
                  });
                } catch (e) {
                  console.warn('동의 scope 조회 생략/실패:', e);
                }

                // ✅ 저장 3) 설문 결과 문서에 링크/표시 정보 갱신(역할 분리 유지)
                await updateDoc(
                  doc(db, `users/${userId}/survey_results/${surveyUUID}`),
                  {
                    kakaoLinked: true,
                    linkedAt: serverTimestamp(),
                    kakaoUid: kakaoId,
                    kakaoEmail: email || null,
                    kakaoNickname: nickname || null,
                    // TTL 해제
                    expiresAt: null
                  }
                );

                // ✅ 이동
                localStorage.setItem('loginSource', 'result');
                const m = location.pathname.match(/^(.*)\/owner-?survey\/.*$/i);
                const basePath = m ? m[1] : ''; // 예: '', '/nbso'
                const target = new URL(`${basePath}/survey-result.html`, location.origin);
                target.searchParams.set('uuid', surveyUUID);
                window.location.href = target.href;

              } catch (e) {
                console.error('카카오 연동 중 오류:', e);
                alert('카카오 연동 중 오류가 발생했습니다.');
              }
            },
            fail: function (e) {
              console.error('사용자 정보 요청 실패:', e);
              alert('사용자 정보 요청 실패');
            }
          });
        },
        fail: function (err) {
          console.error('로그인 실패:', err);
          alert('카카오 로그인 실패');
        }
      });
    };

    // 시작

    window.addEventListener('load', () => {
      // #status가 없으면 눈에 안 보이는 상태로 하나 만들기 (UI 영향 없음)
      let st = document.getElementById('status');
      if (!st) {
        st = document.createElement('div');
        st.id = 'status';
        st.style.display = 'none';    // 화면에 표시되지 않음
        document.body.appendChild(st);
      }
      st.textContent = 'Firebase 준비 중...';
      setupFirebase();
    });
  </script>
</body>

</html>