<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>설문 결과</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .result-wrapper {
      max-width: 600px;
      margin: 3em auto;
      padding: 2em;
      background-color: #fdfdfd;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .result-item {
      margin-bottom: 1.5em;
      padding: 1em;
      background: #fafafa;
      border-left: 4px solid #333;
    }

    .checkbox-group a {
      color: black;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .checkbox-group a:hover {
      color: blue;
    }

    h2 {
      text-align: center;
      margin-bottom: 1em;
    }

    .back-btn,
    .kakao-btn {
      display: block;
      margin: 2em auto 0;
      padding: 0.8em 2em;
      font-size: 1.1em;
      background-color: black;
      color: white;
      border: none;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
    }

    .checkbox-group {
      margin-top: 2em;
      font-size: 0.95em;
    }

    .checkbox-group label {
      display: block;
      margin-bottom: 0.5em;
    }

    small {
      display: block;
      margin-top: 1em;
      font-size: 0.85em;
      color: #555;
    }
  </style>
  <!-- ✅ 카카오 SDK 추가 -->
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
</head>
<script>
  function openPopup(url) {
    window.open(url, 'popup', 'width=600,height=700,scrollbars=yes,resizable=yes');
  }
</script>

<body>
  <div class="result-wrapper">
    <h2>사장님의 MOTI 설문이 완료되었습니다!</h2>
    <p>사장님의 유형 및 맞춤 결과는 카카오톡 채널을 통해 전송됩니다.</p>
    
    <button class="kakao-btn" onclick="submitResult()">카카오로 결과 받기</button>
    <a href="index.html" class="back-btn">다시 하기</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
      authDomain: "nbso-b7f41.firebaseapp.com",
      projectId: "nbso-b7f41",
      storageBucket: "nbso-b7f41.firebasestorage.app",
      messagingSenderId: "94203359555",
      appId: "1:94203359555:web:07f9ee21d1291670363ff6",
      measurementId: "G-YCWF8ENKC4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ 카카오 SDK 초기화
    Kakao.init("cc58d703cacde86ff1976fd723a04854"); // 여기에 실제 앱 키를 사용하세요.

    async function saveResultToFirestore() {
      if (localStorage.getItem("resultSaved") === "true") return null;
      try {
        const answers = JSON.parse(localStorage.getItem("surveyAnswers"));
        const scores = JSON.parse(localStorage.getItem("surveyScores"));
        
        const res = await fetch("data/question.json");
        const questionsData = await res.json();
        
        const allResponses = [];

        // ✅ 질문 데이터를 globalIndex로 빠르게 찾기 위한 맵 생성
        const questionMap = {};
        questionsData.common.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "common" });
        questionsData.stage1.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage1" });
        for (const key in questionsData.stage2) {
            questionsData.stage2[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage2" });
        }
        for (const key in questionsData.stage3) {
            questionsData.stage3[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage3" });
        }

        // ✅ localStorage의 answers를 직접 순회하며 응답 배열 생성
        for (const key in answers) {
          if (key.startsWith('question-')) {
            const globalIndex = key.split('-')[1];
            const q = questionMap[globalIndex];
            const answerValue = answers[key];

            if (q && answerValue !== undefined) {
              const entry = {
                stage: q.stage,
                question: q.question,
                answer: q.options[answerValue]
              };
              if (q.type) {
                const [left, right] = q.type.split("/");
                entry.type = q.type;
                entry.score = answerValue == "0" ? left : right;
              }
              allResponses.push(entry);
            }
          }
        }
        
        const finalType = calculateFinalType(scores);

        const docRef = await addDoc(collection(db, "survey_results"), {
          timestamp: serverTimestamp(),
          expiresAt: new Date(Date.now() + 60 * 60 * 1000),
          responses: allResponses, // ✅ 이제 responses 배열이 제대로 채워집니다.
          finalScores: scores,
          finalType: finalType,
        });

        localStorage.setItem("resultSaved", "true");
        localStorage.setItem("surveyUUID", docRef.id);
        console.log("✅ 설문 결과 저장됨. UUID:", docRef.id);
        return docRef.id;
      } catch (error) {
        console.error("❌ Firestore 저장 중 오류:", error);
        return null;
      }
    }

    function calculateFinalType(scores) {
        let motiType = "";
        const pairs = [
            { axis1: "S", axis2: "I" },
            { axis1: "W", axis2: "T" },
            { axis1: "L", axis2: "R" },
            { axis1: "E", axis2: "Q" }
        ];

        pairs.forEach(pair => {
            if (scores[pair.axis1] > scores[pair.axis2]) {
                motiType += pair.axis1;
            } else if (scores[pair.axis2] > scores[pair.axis1]) {
                motiType += pair.axis2;
            } else {
                motiType += pair.axis1; 
            }
        });
        return motiType;
    }

    window.submitResult = async function () {
      const surveyUUID = await saveResultToFirestore();
      if (!surveyUUID) {
        alert("설문 결과 저장에 실패했습니다. 다시 시도해주세요.");
        return;
      }

      Kakao.Auth.login({
        success: function (authObj) {
          Kakao.API.request({
            url: '/v2/user/me',
            success: async function (res) {
              const kakaoId = res.id.toString();
              const account = res.kakao_account;
              
              const userData = {
                nickname: account.profile?.nickname || "",
                gender: account.gender || "",
                age_range: account.age_range || "",
                phone_number: account.phone_number || "",
                lastLoginAt: serverTimestamp()
              };

              try {
                const userRef = doc(db, "users", kakaoId);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const existingData = userDoc.data();
                  const surveyResults = existingData.surveyResults || [];
                  surveyResults.push(surveyUUID);

                  await setDoc(userRef, { 
                    ...userData,
                    surveyResults: [...new Set(surveyResults)]
                  }, { merge: true });

                  console.log("✅ 기존 사용자 - Firestore 정보 업데이트 및 설문 UUID 추가");
                } else {
                  await setDoc(userRef, { 
                    ...userData,
                    surveyResults: [surveyUUID]
                  });

                  console.log("✅ 신규 사용자 - Firestore 저장 완료");
                }
                
                window.location.href = "kakao-login-success.html";

              } catch (error) {
                console.error("❌ Firestore 저장 실패:", error);
                alert("회원가입/로그인 저장 실패");
              }
            },
            fail: function (error) {
              console.error("❌ 사용자 정보 요청 실패:", error);
              alert("사용자 정보 요청 실패");
            }
          });
        },
        fail: function (err) {
          console.error("❌ 로그인 실패:", err);
          alert("카카오 로그인 실패");
        }
      });
    };
  </script>
</body>

</html>
