<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>로그인 완료 | 착한소상공인지원마켓</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="page-wrapper" class="w-full max-w-xl bg-white p-8 sm:p-12 rounded-xl shadow-lg text-center">
        <!-- 로딩 스피너 -->
        <div id="loading" class="flex flex-col items-center justify-center space-y-4">
            <svg class="animate-spin h-10 w-10 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="text-gray-600 font-medium">사용자 정보를 처리 중입니다...</p>
        </div>

        <!-- 로그인 완료 메시지 (처리가 끝나면 표시) -->
        <div id="success-content" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">
                ✅ 회원가입 및 로그인이 완료되었습니다!
            </h2>
            <p class="text-lg text-gray-600 mb-8">
                환영합니다. 착한소상공인지원마켓의 다양한 서비스를 이용해 보세요.
            </p>
            <a href="index.html"
                class="inline-block bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-colors duration-300">
                홈페이지로 가기
            </a>
        </div>

        <!-- 오류 메시지 (오류 발생 시 표시) -->
        <div id="error-content" class="hidden">
            <h2 class="text-3xl font-bold text-red-500 mb-4">
                ❌ 로그인 중 오류 발생
            </h2>
            <p id="error-message" class="text-lg text-gray-600 mb-8">
                다시 시도해 주세요.
            </p>
            <a href="kakao-login.html"
                class="inline-block bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-colors duration-300">
                다시 로그인하기
            </a>
        </div>
    </div>

    <!-- 카카오 SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <!-- Firebase + 사용자 정보 저장 -->
    <script type="module">
        // Firebase CDN imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, serverTimestamp, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 전역 변수에서 Firebase 설정 가져오기
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;

        // UI 요소
        const loadingScreen = document.getElementById('loading');
        const successContent = document.getElementById('success-content');
        const errorContent = document.getElementById('error-content');
        const errorMessageElement = document.getElementById('error-message');

        function showError(message) {
            loadingScreen.classList.add('hidden');
            errorContent.classList.remove('hidden');
            errorMessageElement.textContent = message;
        }

        async function initFirebaseAndAuth() {
            try {
                // Firebase 앱 초기화
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Firebase 인증
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("✅ Custom token으로 인증 완료");
                } else {
                    await signInAnonymously(auth);
                    console.log("✅ 익명으로 인증 완료");
                }
                userId = auth.currentUser.uid;
                console.log("✅ 현재 사용자 UID:", userId);
            } catch (e) {
                console.error("❌ Firebase 초기화 또는 인증 실패:", e);
                showError("Firebase 초기화 중 오류가 발생했습니다.");
                throw e; // 오류를 다시 던져서 이후 로직이 실행되지 않게 함
            }
        }

        async function saveUserData(userInfo) {
            // 사용자 정보 저장 경로: /artifacts/{appId}/users/{userId}/user_data
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data`, userInfo.uid.toString());
            await setDoc(userDocRef, {
                ...userInfo,
                firestoreUid: userId,
                connectedAt: serverTimestamp()
            });
            console.log("✅ 사용자 정보 저장 완료");
        }

        async function linkSurveyResult(userInfo) {
            const surveyUUID = localStorage.getItem("surveyUUID");
            if (surveyUUID) {
                try {
                    // 설문 결과 저장 경로: /artifacts/{appId}/public/data/survey_results
                    const surveyRef = doc(db, `artifacts/${appId}/public/data/survey_results`, surveyUUID);
                    await updateDoc(surveyRef, {
                        kakaoUid: userInfo.uid,
                        kakaoEmail: userInfo.email,
                        kakaoNickname: userInfo.nickname,
                        connectedAt: serverTimestamp()
                    });
                    console.log("✅ 설문 결과와 카카오 사용자 연결 완료");
                } catch (e) {
                    console.error("❌ 설문 결과 연결 실패:", e);
                }
            } else {
                console.warn("❗ surveyUUID 없음: 설문 결과 연결 생략");
            }
        }

        async function processLogin() {
            await initFirebaseAndAuth();

            Kakao.init('cc58d703cacde86ff1976fd723a04854');

            Kakao.API.request({
                url: '/v2/user/me',
                success: async function (response) {
                    const userInfo = {
                        uid: response.id,
                        email: response.kakao_account?.email ?? null,
                        phone: response.kakao_account?.phone_number ?? null,
                        gender: response.kakao_account?.gender ?? null,
                        age_range: response.kakao_account?.age_range ?? null,
                        nickname: response.properties?.nickname ?? null,
                        profile_image: response.properties?.profile_image ?? null,
                        timestamp: serverTimestamp(),
                        loginSource: localStorage.getItem("loginSource") || "unknown",
                        marketingConsent: response.kakao_account?.marketing?.enabled ?? false
                    };

                    try {
                        // Firebase에 사용자 정보 저장
                        await saveUserData(userInfo);

                        // 설문 결과와 연결
                        if (userInfo.loginSource === "result") {
                            await linkSurveyResult(userInfo);
                        }

                        // 로컬 스토리지 정리
                        localStorage.removeItem("loginSource");
                        localStorage.removeItem("surveyUUID");

                        // 성공 UI 표시
                        loadingScreen.classList.add('hidden');
                        successContent.classList.remove('hidden');

                    } catch (e) {
                        console.error("❌ Firebase 데이터 처리 실패:", e);
                        showError("데이터 저장 중 오류가 발생했습니다.");
                    }
                },
                fail: function (error) {
                    console.error("❌ 카카오 사용자 정보 요청 실패:", error);
                    showError("카카오 사용자 정보를 가져오는 데 실패했습니다.");
                }
            });
        }

        // 페이지 로드 시 로그인 처리 시작
        processLogin().catch(e => {
            console.error("❌ 전체 로그인 처리 과정 실패:", e);
        });
    </script>
</body>

</html>